<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrecioF√°cil üè∑Ô∏è | Comparador de Precios Online - Encuentra los Mejores Precios</title>
    <meta name="description" content="Compara precios en tiempo real entre miles de tiendas online con PrecioF√°cil. Ahorra hasta un 40% encontrando las mejores ofertas y promociones en electr√≥nica, hogar y moda.">
    <meta name="keywords" content="comparador de precios, ofertas online, ahorrar en compras, comparar productos, mejor precio, promociones, descuentos, compras online">
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        body {
            background-color: #f9fafb;
            color: #111827;
        }
        
        /* Estilos del navbar */
        .navbar {
            width: 100%;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .navbar-container {
            padding: 0.75rem 0;
        }
        
        .navbar-content {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        
        /* Logo y t√≠tulo */
        .brand {
            display: flex;
            align-items: center;
            color: #111827;
            text-decoration: none;
            margin-right: 0.5rem;
        }
        
        .brand-icon {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.5rem;
            color: #4f46e5;
        }
        
        .brand-name {
            font-weight: 700;
            font-size: 1.25rem;
            white-space: nowrap;
        }
        
        /* Formulario de b√∫squeda */
        .search-form {
            display: flex;
            flex: 1;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-width: 0;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        /* Corregido: Posicionamiento del icono de b√∫squeda */
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            pointer-events: none; /* Asegura que el icono no interfiera con el input */
            z-index: 1; /* Asegura que el icono est√© por encima del input */
        }
        
        .search-input {
            width: 100%;
            height: 2.5rem;
            padding: 0 0.75rem 0 2.25rem; /* Espacio a la izquierda para el icono */
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: white;
            color: #111827;
            transition: all 0.2s;
            position: relative; /* Asegura el correcto posicionamiento */
        }
        
        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }
        
        /* Dropdown de marketplaces */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-button {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            height: 2.5rem;
            padding: 0 0.75rem;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .dropdown-button:hover {
            background-color: #f9fafb;
        }
        
        .dropdown-icon {
            width: 0.875rem;
            height: 0.875rem;
            margin-left: 0.25rem;
            transition: transform 0.2s;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            margin-top: 0.25rem;
            min-width: 12rem;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown:hover .dropdown-icon {
            transform: rotate(180deg);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        
        .dropdown-checkbox {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: white;
        }
        
        .dropdown-item.selected .dropdown-checkbox {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        
        .dropdown-item.selected .dropdown-checkbox::after {
            content: "";
            width: 0.375rem;
            height: 0.375rem;
            background-color: white;
            border-radius: 50%;
        }
        
        /* Bot√≥n de comparar */
        .compare-button {
            height: 2.5rem;
            padding: 0 1rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .compare-button:hover:not(:disabled) {
            background-color: #4338ca;
        }
        
        .compare-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Spinner de carga */
        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Overlay de carga */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 20rem;
            margin: 0 1rem;
        }
        
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
        }
        
        .loading-text {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* Etiquetas de marketplaces */
        .marketplace-tags {
            display: none;
            flex-wrap: wrap;
            gap: 0.375rem;
        }
        
        .marketplace-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.75rem;
            color: #4b5563;
            white-space: nowrap;
        }
        
        /* SVG Icons - Corregidos para mejor visualizaci√≥n */
        .icon-cart {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='9' cy='21' r='1'%3E%3C/circle%3E%3Ccircle cx='20' cy='21' r='1'%3E%3C/circle%3E%3Cpath d='M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6'%3E%3C/path%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .icon-search {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .icon-chevron {
            display: inline-block;
            width: 0.875rem;
            height: 0.875rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        /* Contenido principal */
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #111827;
        }
        
        .card-text {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .placeholder {
            padding: 1.5rem;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            text-align: center;
            color: #6b7280;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .navbar-container {
                padding: 1rem 0;
            }
            
            .marketplace-tags {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container navbar-container">
            <div class="navbar-content">
                <!-- Logo y nombre -->
                <a href="#" class="brand">
                    <span class="icon-cart"></span>
                    <span class="brand-name">PrecioF√°cil</span>
                </a>
                
                <!-- Formulario de b√∫squeda -->
                <form class="search-form" method="post">
                    {% csrf_token %}
                    <div class="search-wrapper">
                        <div class="icon-search search-icon"></div>
                        <input type="text" name="search_item" value="{{ search_query }}" class="search-input" placeholder="Buscar productos...">
                    </div>
                    
                    <!-- Dropdown de marketplaces -->
                    <div class="dropdown">
                        <button type="button" class="dropdown-button">
                            Marketplaces
                            <span class="icon-chevron"></span>
                        </button>
                        <div class="dropdown-content">
                            {% for s in available_sources %}
                            <label class="dropdown-item {% if not selected_sources or s.key in selected_sources %}selected{% endif %}">
                                <input style="display:none" type="checkbox" name="sources" value="{{ s.key }}" {% if not selected_sources or s.key in selected_sources %}checked{% endif %}>
                                <span class="dropdown-checkbox"></span>
                                <span>{{ s.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <button type="submit" class="compare-button" id="compareBtn">
                        <span class="spinner" id="btnSpinner" style="display: none;"></span>
                        <span id="btnText">Comparar</span>
                    </button>
                </form>
                
                <!-- Etiquetas de marketplaces -->
                <div class="marketplace-tags">
                    {% for s in available_sources %}
                        {% if not selected_sources or s.key in selected_sources %}
                        <div class="marketplace-tag">{{ s.label }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Contenido principal -->
    <main class="container main-content">
        <div class="card">
            <h1 class="card-title">Comparador de Precios</h1>
            <p class="card-text">
                Busca productos y compara precios en diferentes marketplaces como Mercado Libre COL, Falabella y m√°s.
            </p>
            
            {% if not search_query %}
            <div class="placeholder">
                <p>Utiliza la barra de b√∫squeda en la parte superior para encontrar y comparar precios de productos.</p>
                
            </div>
            {% endif %}
            {% if search_query %}
                <p><strong>B√∫squeda realizada:</strong> {{ search_query }}</p>

                {% if errors %}
                    <div class="placeholder" style="border-color:#ef4444;color:#b91c1c; text-align:left;">
                        <div style="font-weight:700;margin-bottom:0.5rem;">Avisos:</div>
                        <ul style="padding-left:1rem;">
                            {% for e in errors %}
                            <li>{{ e }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if best_item %}
                <div class="card" style="margin-top:1rem;border:2px solid #10b981">
                    <div style="font-weight:700;color:#065f46;margin-bottom:0.5rem;">Mejor precio</div>
                    <a href="{{ best_item.link }}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">
                        <div style="display:flex; gap:0.75rem; align-items:flex-start;">
                            {% if best_item.thumbnail %}
                            <img src="{{ best_item.thumbnail }}" alt="{{ best_item.title }}" style="width:80px;height:80px;object-fit:cover;border-radius:0.375rem;flex:0 0 auto;" />
                            {% endif %}
                            <div style="display:flex;flex-direction:column;gap:0.25rem;">
                                <div style="font-weight:600;">{{ best_item.title }}</div>
                                <div style="color:#111827;font-weight:700;">{{ best_item.price_str }}</div>
                                <div style="font-size:0.75rem;color:#6b7280;">{{ best_item.source|default:'-' }}</div>
                            </div>
                        </div>
                    </a>
                </div>
                {% endif %}

                {% if results %}
                <div style="margin-top:1rem; display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 1rem;">
                    {% for item in results %}
                    <a href="{{ item.link }}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">
                        <div class="card" style="padding:1rem; display:flex; gap:0.75rem; align-items:flex-start;">
                            {% if item.thumbnail %}
                            <img src="{{ item.thumbnail }}" alt="{{ item.title }}" style="width:80px;height:80px;object-fit:cover;border-radius:0.375rem;flex:0 0 auto;" />
                            {% endif %}
                            <div style="display:flex;flex-direction:column;gap:0.25rem;">
                                <div style="font-weight:600;">{{ item.title }}</div>
                                <div style="color:#111827;font-weight:700;">{{ item.price_str }}</div>
                                <div style="font-size:0.75rem;color:#6b7280;">{{ item.source|default:'Mercado Libre' }}</div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="placeholder">No se encontraron resultados.</div>
                {% endif %}
            {% endif %}
        </div>
    </main>
    
    <!-- Overlay de carga -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-title">Buscando precios...</div>
            <div class="loading-text">Comparando en diferentes marketplaces para encontrar las mejores ofertas</div>
        </div>
    </div>
    
    <script>
        const url = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, url);
        localStorage.removeItem('search_item');
        
        // Funcionalidad de loading
        const form = document.querySelector('.search-form');
        const compareBtn = document.getElementById('compareBtn');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const searchInput = document.querySelector('.search-input');
        
        // Variables de control
        let loadingStartTime = null;
        let isLoading = false;
        const MIN_LOADING_TIME = 800; // M√≠nimo 800ms para evitar parpadeo
        
        // Mensajes de carga aleatorios para variedad
        const loadingMessages = [
            {
                title: "Buscando precios...",
                text: "Comparando en diferentes marketplaces para encontrar las mejores ofertas"
            },
            {
                title: "Analizando productos...",
                text: "Revisando miles de productos para darte los mejores resultados"
            },
            {
                title: "Comparando precios...",
                text: "Encontrando las ofertas m√°s convenientes para ti"
            },
            {
                title: "Procesando b√∫squeda...",
                text: "Esto puede tomar unos segundos, ¬°vale la pena esperar!"
            }
        ];
        
        function showLoading() {
            if (isLoading) return; // Prevenir m√∫ltiples llamadas
            
            isLoading = true;
            loadingStartTime = Date.now();
            
            // Cambiar bot√≥n
            compareBtn.disabled = true;
            btnSpinner.style.display = 'block';
            btnText.textContent = 'Buscando...';
            
            // Mostrar overlay con mensaje aleatorio
            const randomMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            const titleElement = loadingOverlay.querySelector('.loading-title');
            const textElement = loadingOverlay.querySelector('.loading-text');
            
            titleElement.textContent = randomMessage.title;
            textElement.textContent = randomMessage.text;
            
            loadingOverlay.style.display = 'flex';
            
            // Bloquear scroll
            document.body.style.overflow = 'hidden';
        }
        
        function hideLoading() {
            if (!isLoading) return; // No hacer nada si no est√° cargando
            
            const elapsedTime = Date.now() - loadingStartTime;
            const remainingTime = Math.max(0, MIN_LOADING_TIME - elapsedTime);
            
            // Esperar el tiempo m√≠nimo antes de ocultar
            setTimeout(() => {
                isLoading = false;
                
                // Restaurar bot√≥n
                compareBtn.disabled = false;
                btnSpinner.style.display = 'none';
                btnText.textContent = 'Comparar';
                
                // Ocultar overlay con transici√≥n suave
                loadingOverlay.style.display = 'none';
                
                // Restaurar scroll
                document.body.style.overflow = '';
            }, remainingTime);
        }
        
        // Event listener para el formulario
        form.addEventListener('submit', function(e) {
            const query = searchInput.value.trim();
            
            // Solo mostrar loading si hay una b√∫squeda v√°lida
            if (query) {
                showLoading();
            }
        });
        
        // Detectar si la p√°gina se est√° cargando con resultados
        const hasSearchResults = {{ search_query|yesno:"true,false" }};
        const isPageLoad = !document.referrer || document.referrer === window.location.href;
        
        // Solo ocultar loading si realmente hab√≠a loading activo
        window.addEventListener('DOMContentLoaded', function() {
            // Si hay resultados y venimos de una b√∫squeda, ocultar loading
            if (hasSearchResults && isLoading) {
                hideLoading();
            }
        });
        
        // Manejar navegaci√≥n del browser
        window.addEventListener('pageshow', function(event) {
            // Si la p√°gina viene del cache (bot√≥n atr√°s), resetear estado
            if (event.persisted) {
                isLoading = false;
                loadingOverlay.style.display = 'none';
                document.body.style.overflow = '';
                compareBtn.disabled = false;
                btnSpinner.style.display = 'none';
                btnText.textContent = 'Comparar';
            }
        });
    </script>
</body>
</html>